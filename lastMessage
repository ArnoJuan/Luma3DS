Fix broken assumptions and bugs
