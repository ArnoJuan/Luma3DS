Move screen management code to screen.c and fix cache-related issues
