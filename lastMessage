Disable interrupts and do some refactoring.
