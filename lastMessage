Refactor firm.c as well as other files
